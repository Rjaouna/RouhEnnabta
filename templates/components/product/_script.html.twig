 <script>
// =====================
// ELEMENTS
// =====================
const productForm = document.getElementById('product-form');
const productList = document.getElementById('product-list');

const productId = document.getElementById('product-id');
const productName = document.getElementById('product-name');
const productSlug = document.getElementById('product-slug');
const productDescription = document.getElementById('product-description');

const productPurchase = document.getElementById('product-purchase');
const productMargin = document.getElementById('product-margin');
const productSale = document.getElementById('product-sale');

const productStock = document.getElementById('product-stock');
const productCategory = document.getElementById('product-category');
const productGamme = document.getElementById('product-gamme');
const productActive = document.getElementById('product-active');

// =====================
// SELECTS
// =====================
function loadSelects() {
  fetch('/api/categories')
    .then(r => r.json())
    .then(data => {
      productCategory.innerHTML =
        '<option value="">Cat√©gorie</option>' +
        data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    });

  fetch('/api/gammes')
    .then(r => r.json())
    .then(data => {
      productGamme.innerHTML =
        '<option value="">Gamme</option>' +
        data.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    });
}

// =====================
// CALCUL PRIX
// =====================
function calcPrice() {
  const p = parseFloat(productPurchase.value) || 0;
  const m = parseFloat(productMargin.value) || 0;
  productSale.value = p && m ? (p + p * m / 100).toFixed(2) : '';
}

productPurchase.addEventListener('input', calcPrice);
productMargin.addEventListener('input', calcPrice);

// =====================
// LISTE
// =====================
function loadProducts() {
  fetch('/api/products')
    .then(r => r.json())
.then(data => {

      productList.innerHTML = '';
      data.forEach(p => {
		const imageUrl = p.mainImage
  ? `/uploads/products/${p.mainImage}`
  : '/assets/img/placeholder-product.jpg';

       productList.innerHTML += `
<tr class="${p.isActive ? '' : 'table-secondary'}">
<td style="width:70px">
	<img src="${imageUrl}" class="rounded border" style="width:60px;height:60px;object-fit:cover">
</td>
  <td>
    <strong>${p.name}</strong>
    <div class="text-muted small">
      ${p.description ?? ''}
    </div>
  </td>

  <td>
    <span class="badge bg-light text-dark">
      Achat : ${p.purchasePrice ?? '-'} ‚Ç¨
    </span><br>
    <span class="badge bg-success mt-1">
      Vente : ${p.salePrice ?? '-'} ‚Ç¨
    </span>
  </td>

  <td>
    <span class="badge bg-info">
      ${p.margin ?? 0} %
    </span>
  </td>

  <td>
    <span class="badge ${p.stock > 0 ? 'bg-primary' : 'bg-danger'}">
      ${p.stock ?? 0}
    </span>
  </td>

  <td>
    <span class="badge bg-secondary">
${p.categoryName  ?? '-'}

    </span>
  </td>

  <td>
    <span class="badge bg-warning text-dark">
${p.gammeName  ?? '-'}

    </span>
  </td>

  <td class="text-center">
    ${p.isActive 
      ? '<span class="badge bg-success">Actif</span>' 
      : '<span class="badge bg-danger">Inactif</span>'}
  </td>

  <td class="text-end">
    <button class="btn btn-sm btn-outline-warning me-1"
onclick="editProduct(${p.id}); openProductModal();">

      ‚úèÔ∏è
    </button>
    <button class="btn btn-sm btn-outline-danger"
      onclick="deleteProduct(${p.id})">
      üóë
    </button>
<a href="/admin/product/${p.id}/images" class="btn btn-outline-secondary btn-sm">
	üì∏
</a>


  </td>
</tr>
`;

      });
    });
}

// =====================
// MODAL
// =====================
function openProductModal() {
  new bootstrap.Modal(
    document.getElementById('productModal')
  ).show();
}

// =====================
// EDIT
// =====================
function editProduct(id) {
  fetch('/api/products')
    .then(r => r.json())
    .then(data => {
      const p = data.find(p => p.id === id);

      productId.value = p.id;
      productName.value = p.name;
      productSlug.value = p.slug ?? '';
      productDescription.value = p.description ?? '';
      productPurchase.value = p.purchasePrice ?? '';
      productMargin.value = p.margin ?? '';
      productStock.value = p.stock ?? '';
      productActive.checked = p.isActive;

      productCategory.value = p.category;
      productGamme.value = p.gamme;

      calcPrice();
    });
    
}

// =====================
// DELETE
// =====================
function deleteProduct(id) {
  if (!confirm('Supprimer ce produit ?')) return;
  fetch(`/api/products/${id}`, { method: 'DELETE' })
    .then(loadProducts);
}

// =====================
// SUBMIT
// =====================
productForm.addEventListener('submit', e => {
  e.preventDefault();

  const id = productId.value;
  const url = id ? `/api/products/${id}` : '/api/products';
  const method = id ? 'PUT' : 'POST';

  fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: productName.value,
      slug: productSlug.value,
      description: productDescription.value,
      purchasePrice: productPurchase.value,
      margin: productMargin.value,
      stock: productStock.value,
      category: productCategory.value,
      gamme: productGamme.value,
      isActive: productActive.checked
    })
  }).then(() => {
    productForm.reset();
    productId.value = '';
    loadProducts();

   // ‚úÖ FERMETURE AUTOMATIQUE DU MODAL
    const modalEl = document.getElementById('categoryModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  });
  function generateSlug(text) {
  return text
    .toLowerCase()
    .trim()
    .normalize('NFD')                 // enl√®ve accents
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')      // espaces ‚Üí -
    .replace(/(^-|-$)/g, '');
}

productName.addEventListener('input', () => {
  productSlug.value = generateSlug(productName.value);
});
});

// =====================
// INIT
// =====================
loadSelects();
loadProducts();
</script>

